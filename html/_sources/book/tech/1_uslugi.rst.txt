Виды предоставляемых услуг связи
================================

Наша компания предоставляет широкий спектр услуг: доступ в Интернет, L2 VPN, L3 VPN,, услуги по мониторингу объектов клиента.

Основным видом транспорта для всех видов услуг являются сети 3G/LTE. 

Устройство магистрального узла в г. Москве
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Центральный узел связи в г. Москве состоит из 2 географически распределенных маршрутизаторов: Cisco ASR1006 (ММТС9) и Cisco ASR1002 (Профсоюзная 108), 3х коммутаторов HP A5500 (ММТС9), 2х коммутаторов HP A5500 (Профсоюзная 108). Маршрутизаторы являются пограничными. На каждом из них работает BGP сессия с вышестоящими операторами.

В качестве ядра для предоставления услуг клиентам используются Mikrotik 1036 в количестве 8 штук. 6 из них служат для предоставления услуг L2 VPN/L3 VPN, 2 других для предоставления доступа в Интернет. Они в свою очередь также попарно географически разделены.

Маршрутизаторы Cisco 2911 и Cisco 7201 находящиеся на ММТС9, используются для работы xconnect’ов (необходимо для предоставления услуги L2 VPN).

Также на ММТС9 есть АТС M-200 (телефония) и система DPI обеспечивающая выполнение ФЗ-139; ФЗ-149; ФЗ-187; ФЗ-398; ФЗ-436.

Для распределения маршрутной информации на всех маршрутизаторах используется протокол динамической маршрутизации OSPF.

Вся серверная инфраструктура базируется на Профсоюзной 108. 

.. figure:: ../../_static/images/tech/1_uslugi/Типовая_схема_РУС.png
    :align: center
    :alt: Типовая_схема_РУС.png

    Типовая схема регионального узла связи

Устройство магистральной сети АО «Смарт Инжиниринг»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Магистральная сеть АО «Смарт Инжиниринг» состоит из связанных между собой регионально распределенных узлов. Для поддержания беспрерывной работоспособности каждый узел связи имеет 2 или более канала до других регионов. Для распределения маршрутной информации и состояниях «путей» внутри РУС и между регионами обеспечивает протокол динамической маршрутизации OSPF.

Схема магистральной сети АО «Смарт Инжиниринг»:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Каждый региональный узел связи имеет 2 независимых ввода интернета (используются для построения туннелей L2TP/GRE от Си-3М) резервированные маршрутизаторы, 2 коммутатора в стэке, а также ИБП. Типовой узел представлен на схеме. В качестве маршрутизаторов используются 2 Cisco 7201 и 2 Mikrotik 1016 (не везде), коммутаторы Cisco 2960. 


Услуга «Доступ в Интернет»
--------------------------

С этой услугой заказчик получает доступ в интернет. Возможно предоставление как серого, так и белого (или нескольких) IP-адреса, выделяемого из нашего адресного пространства. Предоставляется поверх 3G/LTE сетей мобильных операторов или агрегации.

В случае услуги с серым IP-адресом заказчик NAT’итурется на магистральном оборудовании в белые IP-адреса.

На данный момент все подключения с услугой доступа в интернет терминируются в Москве, т.к. выделенное RIPE адресное пространство маршрутизируется здесь. Транзит интернет трафика осуществляют вышестоящие операторы - «MSK-IX» и FIORD.

Так же бывают исключения, когда NAT/PAT происходит на каналообразующем оборудовании Си-3М (hAP). Т.е. фактически белый IP-адрес выдается, но прописывается на нашем каналообразующем оборудовании.

В проекте АЗС «ЕКА» белый IP-адрес (прописанный на интерфейсе LoopbackNAT) полностью транслируется в серый прописанный на оборудовании клиента.

В проекте для видеонаблюдения ООО «Инфометеосервис» на интерфейсе ether прописана подсеть 10.x.x.x/24 и определенные клиентом наборы портов с белого адреса (находиться на интерфейсе LoopbackNAT) транслируются в серые IP-адреса:порты.

и определенные клиентом наборы портов с белого адреса (находиться на интерфейсе LoopbackNAT) транслируются в серые IP-адреса:порты.

В случаях АВР по данным объектам необходимо сообщать отделу эксплуатации, т.к. конфигурация, генерируемая роботом не полная. 

.. figure:: ../../_static/images/tech/1_uslugi/Схема_Интернет.png
    :align: center
    :alt: Схема_Интернет.png

    Схема предоставления услуги Интернет

Диагностика проблем с услугой «Доступ в Интернет»:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Убедиться в доступности нашего каналообразующего оборудования (Си-3М, hAP (в случае агрегации)), и его нормальной работе. Проверить состояние линка в сторону клиентского оборудования, убедится в том, что на порту не копятся ошибки, он автоматически согласован в 100/1000 Full Duplex и не "флапает" (просмотреть логи).
#. Проверить ARP-записи (IP -> ARP) должен быть IP-адрес клиента на порту отдачи услуги. Пропинговать клиента с оборудования (IP-адрес клиента может быть закрыт на пинг), указав размер пакета 1500 (для проверки прохождения и фрагментации). Если в списки ARP-записей пусто, велика вероятность в неправильной настройке оборудования клиентом, уточнить.
#. Попросить клиента пропинговать 8.8.8.8 и выслать статистику.

Массовые аварии с услугой «Доступ в Интернет»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Массовые аварии могут произойти по причинам: 

#. Падение или нестабильная работа магистрального маршрутизатора. Причинами может послужить сбой ПО маршрутизатора, флуд или ошибка конфигурации.
    * Сбой ПО маршрутизатора может быть вызван ошибкой в коде, которая приводит к переполнению памяти или постоянной нагрузке процессора на 100% и многим другим проблемам. Решается перезагрузкой и обновлением прошивки оборудования.
    * Флуд (постоянный сброс и возобновление L2TP сессий) может произойти из-за проблем с вышестоящий оператором, который обеспечивает транзит интернет трафика.
    * В случае падения магистрально узла работу на себя берет резерв, который географически и логически отделен от основного. Простой во время переключения для точек может составить до нескольких минут.

#. Массовая блокировка SIM-карт. Параллельно с проверкой магистрального оборудования нужно проверить список упавших точек, если есть закономерность по оператору сдать проблему в межоператорский отдел.

#. Проблемы с операторами, обеспечивающими транзит интернет трафика. Если есть потери и/или высокие задержки до белых IP-адресов, прописанных на стыках с операторами сдать проблему оператору. Обязательно необходимо проверить физическое подключение (ошибки на порту, линк). Также бывают проблемы с маршрутами до некоторого количества белых IP-адресов у транзитных операторов (об этом говорит переключение на резерв не всех точек). 

Услуга L2 VPN
-------------

Предоставление заказчику виртуальной частной сети 2го уровня модели OSI (канальный уровень). Предоставляется на основе нашей IP/MPLS сети (с использованием технологии xconnect/vpls). Бывает как point-to-point так и point-to-multipoint.

В случае прямого канала (point-to-point) может использоваться туннель EoIP. В данном варианте IP/MPLS сеть не используется.

В Московском регионе вместо VPLS используется EoIP. 

.. figure:: ../../_static/images/tech/1_uslugi/Типовая_схема_L2.png
    :align: center
    :alt: Типовая_схема_L2.png

    Общая схема предоставления (EoMPLS)* Место терминирования GRE/L2TP туннелей и xconnect/vpls может различаться, т.е. GRE и L2TP могут быть терминированы в одном регионе, а xconnect уже работая поверх IP/MPLS сети приходить в другой.


Диагностика аварий EoMPLS:
~~~~~~~~~~~~~~~~~~~~~~~~~~

При жалобе клиента на неработоспособность услуги необходимо:

#. Убедиться в доступности нашего каналообразующего оборудования (Си-3М, hAP (в случае агрегации)), и его нормальной работе. Проверить состояние линка в сторону клиентского оборудования, убедится в том, что порт автоматически согласован в 100/1000 Full Duplex и не флапает» (просмотреть логи).
#. Убедиться в том, что VPLS туннель на Си-3М (hAP) находится в состоянии Running. Также проверить на стороне терминирующего маршрутизатора состояние xconnect, оно должно быть UP. Проверить это можно командой show xconnect all | i XXXX (VLAN ID). Адрес маршрутизатора можно узнать в настройках VPLS туннеля (Peer).
#. Проверить соответствие MAC-адресов на коммутаторе во влане, должно быть 3 (как минимум) MAC-адреса, это клиентское оборудование (находящиеся за ether), клиентское оборудование на другой стороне (в случае сервиса точка-точка), и наш коммутатор.

В случае неработоспособности VPLS туннеля:

#. Проверить с каким размером пакетов проходят пинги до Си-3М, должно быть 1500. Если пакеты не проходят необходимо перезагрузить оборудование.
#. Перезагрузить VPLS-туннель (кнопкой Disable/Enable).
#. Перезагрузить оборудование.
#. Сменить режим работы мобильной сети (3G/LTE)

Если данные этапы не помогли сдать проблему в ОЭ.

В случае отсутствия необходимых MAC-адресов необходимо:

#. согласовать тестовую сеть /29 с клиентом;
#. прописать свободный адрес из этой подсети на интерфейсе L2XC на Си-3м;
#. проверить доступность занятых клиентом адресов пакетами по 1500 байт;
    * Если есть проблемы с прохождением пакетов до клиентского оборудования, значит проблемы с физикой на объекте - необходимо связаться с объектом и переткнуть кабеля на оборудовании.
    * Если есть проблемы с прохождением пакетов до РУС, значит проблемы на радиоканале и необходимо сменить режим работы и/или перезагрузить наше оборудование на объекте.

Массовые аварии с услугой L2 VPN
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Причинами массовых аварий могут быть те же, что при услуге «Доступ в Интернет». 

Услуга L3 VPN
-------------

Предоставление заказчику виртуальной частной сети 3го уровня модели OSI. Маршрутизация трафика клиента производится на нашей стороне. Используются технологии BGP, VRF, MPLS.

При предоставлении услуги L3 VPN используются протокол BGP с технологией VRF. BGP (Border Gateway Protocol) как протокол маршрутизации, VRF (Virtual Routing And Forwarding) для отделения сетей клиента от общего адресного пространства.

Примером можно считать проект, реализованный для ООО «Башнефть-Розница». 

.. figure:: ../../_static/images/tech/1_uslugi/Типовая_схема_L3.png
    :align: center
    :alt: Типовая_схема_L3.png

    Типовая схема L3

Диагностика проблем с услугой L3 VPN на конечных точках:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

При обращении заказчика на неработоспособность:

#. Убедиться в доступности нашего каналообразующего оборудования (Си-3М, hAP (в случае агрегации)), и его нормальной работе. Проверить состояние линка в сторону клиентского оборудования, убедится в том, что порт автоматически согласован в 100/1000 Full Duplex и не флапает» (просмотреть логи).
#. Проверить ARP-записи (IP -> ARP) должен быть IP-адрес клиента на порту отдачи услуги. Пропинговать клиента с оборудования PE указав необходимый routing table. Если в списки ARP-записей пусто велика вероятность в неправильной настройке оборудования клиентом, уточнить эту информацию.
#. Пропинговать клиентский IP-адрес с магистрального оборудования указав необходимый routing-table и src-address (который прописан на стыке с клиентом), а также указав размер пакета 1500 (для проверки прохождения и фрагментации). Если пакеты не проходят/фрагментируются сдать проблему в отдел эксплуатации.
#. Если IP-адрес не пингуется проверить состояние необходимого BGP-инстанса на каналообразующем оборудовании (Си-3М, hAP), инстанс должен быть в состоянии Running, если состояние отличное от этого, сбросить инстанс (Disable/Enable) и, если не сработало, перезагрузить каналообразующее оборудование. Если инстанс по-прежнему не поднялся и во всех остальных случаях – сдать проблему в отдел эксплуатации.

При обращении заказчика на недоступность определенных адресов с объекта, сделать трассировку до этого адреса указав необходимый routing-table и src-address.

Массовые аварии с услугой L3 VPN
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Причинами массовых аварий могут быть те же, что при услуге «Доступ в Интернет», а также: падение/нестабильная работа стыков с центральными узлами заказчика. Данное падение не будет оказывать влияния на работу каналообразующего оборудования (незаметно для мониторинга), но будет перерыв в работе (пока объекты перейдут на резервный стык). При данной аварии проверить физику в сторону клиента на магистральном оборудовании, проверить прохождение пакетов указав необходимый routing-table. 
.. meta::
   :http-equiv=Content-Type: text/html; charset=utf-8

Тестовая подсеть
================

Здесь мы рассмотрим, что такое тестовая подсеть, для чего вообще она нам нужна и как её использовать.

Иногда клиенты, которым мы доставляем услугу L2-VPN, жалуются на наличие потерь на канале или вовсе на недоступность, хотя при проверке с нашей стороны никаких неисправностей выявлено не было. Для более детальной диагностики канала мы запрашиваем у клиента т.н. тестовую подсеть. 

**Тестовая подсеть** – это IP-адресация, которую мы прописываем внутри L2-туннеля на разных участках сети для детального тестирования канала на этих участках. В услуге L2 мы тянем VLAN от коммутатора клиента на стыке до оборудования на объекте.

.. figure:: ../../_static/images/tech/3_test_network/Тестовая_подсеть_1.png
    :align: center
    :alt: Тестовая_подсеть_1.png

Стык с клиентом — это буквально кабель между нашим коммутатором и клиентским.

Внутри этого VLAN нет нашей IP-адресации, то есть на своем коммутаторе во VLAN клиент прописал IP-адрес и на оборудовании на объекте прописал IP из той же подсети. Другой адресации обычно во VLAN нет. 

.. figure:: ../../_static/images/tech/3_test_network/Тестовая_подсеть_2.png
    :align: center
    :alt: Тестовая_подсеть_2.png

Логически это выглядит как будто протянули кабель от коммутатора до конечного оборудования.

Дома, если есть какие-то проблемы, то ты переткнешь кабель и перезагрузишь роутер, но у нас канал составной, и проблема может быть на любом участке. 

.. figure:: ../../_static/images/tech/3_test_network/Тестовая_подсеть_3.png
    :align: center
    :alt: Тестовая_подсеть_3.png

Тут в дело включается тестовая подсеть – она навешивается на каждом участке и позволяет проверить их на наличие проблем: потери, не проходят большие пакеты,высокие задержки

.. figure:: ../../_static/images/tech/3_test_network/Тестовая_подсеть_4.jpg
    :align: center
    :alt: Тестовая_подсеть_4.jpg

    Схема внутри роутера

.. figure:: ../../_static/images/tech/3_test_network/Ether1_vpls.jpg
    :align: center
    :alt: Ether1_vpls.jpg

    Интерфейсы ether1 и vpls1 имеют флаг S - slave, это значит что они объединены в бридж 

.. figure:: ../../_static/images/tech/3_test_network/Ports_on_bridge.jpg
    :align: center
    :alt: Ports_on_bridge.jpg

    Интерфейсы в бридже

.. figure:: ../../_static/images/tech/3_test_network/Hosts.jpg
    :align: center
    :alt: Hosts.jpg

    МАС-адреса, которые приходят на антенну, флаг L - Local, означает что адреса принадлежат самой антенне, на интерфейс ether1 приходит МАС-адрес с оборудования клиента на объекте, на vpls1- МАС-адрес со стыка

Примерно так это выглядит внутри антенны: на антенне строится интерфейс VPLS или EoIP, в котором ходит маркированный трафик во VLAN, и VLAN этот тянется до стыка с клиентом.

А с другой стороны, есть физический порт ether1, в который подключается конечное оборудование на объекте.

И есть бридж L2XC, который просто пересылает трафик между интерфейсами и внутри этого бриджа мы и видим МАС-адреса, которые прилетают с обеих сторон бриджа – с порта ether1 и с интерфейса VPLS/EoIP (т.е. со стыка).

Когда нам выделяют тестовую подсеть, то мы прописываем свободный адрес на бридже и можем пинговать клиентские адреса в обе стороны.

Обычно мы запрашиваем тестовую подсеть с маской /29, потому что там достаточно свободных адресов, чтобы прописать их на каждом участке.

.. table:: Таблица адресации

    ========= =============== ===============
    Подсеть   /29             /30
    ========= =============== ===============
    Адрес     192.168.62.0    192.168.62.0
    Bitmask   29              30
    Netmask   255.255.255.248 255.255.255.252
    Wildcard  0.0.0.7         0.0.0.3
    Network   192.168.62.0    192.168.62.0
    Broadcast 192.168.62.7    192.168.62.3
    Hostmin   192.168.62.1    192.168.62.1
    Hostmax   192.168.62.6    192.168.62.2
    Hosts     6               2
    ========= =============== ===============


Таким образом, видно, что в /29 подсети 6 адресов, которые можно использовать. Обычно, клиент использует 1 и 2 адреса из подсети, а остальные можем использовать мы.

А в /30 подсети всего 2 адреса, которые можно назначить устройствам, и их полностью занимает клиент. /30 подсеть тоже можно использовать, но есть свои особенности, их мы рассмотрим ниже. 


Как это работает.
-----------------

Теперь рассмотрим, как же пользоваться тестовой подсетью.

Клиент выделил /29 подсеть.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Нужно убедиться в том, что выделенная адресация корректна. Бывает так, что клиент выделяет подсеть, но адреса не соответствуют подсети и тестирование будет некорректно. Для этого нужно зайти на сайт ip-calculator.ru и вставить в поле IP адрес ту тестовую подсеть, которую выделил клиент и нажать Подсчитать. В поле IP адреса можно так же вводить данные в формате IP/mask, например 192.168.0.1/16. В получившейся таблице нужно проверить, что свободные и используемые клиентом адреса находятся в диапазоне между Hostmin и Hostmax. Если всё верно, то переходим к следующему шагу, если же нет, то просим клиента выделить корректную подсеть.
#. Из свободных адресов подсети нужно выбрать один адрес и прописать его на интерфейсе L2XC. Таким образом, мы сможем пинговать как клиентское оборудование на объекте, так и клиентскую адресацию на стыке.
#. Провести стандартное тестирование радиоканала под нагрузкой, но вместо адреса РУСа, нужно пинговать клиентский адрес на стыке. Одновременно с этим нужно пинговать большими пакетами клиентскую адресацию на объекте.
#. Если с нашей стороны всё хорошо, то отправляем клиенту собранную статистику. Если в результате тестирования выявлены проблемы, то устраняем их.
#. После согласования закрытия ТТ нужно удалить тестовую адресацию с интерфейса.

Пример с /29 подсетью.
""""""""""""""""""""""""""

Клиент выделил подсеть 192.168.78.0/29.

На объекте используется 192.168.78.2, на РУС - 192.168.78.1.

Таким образом, свободны адреса 192.168.78.3 и 192.168.78.4, их то мы и используем.

Прописываем 192.168.78.3/29 на интерфейсе L2XC. 

.. note::

    Адресация прописывается в IP -> Adressess, для добавления адреса надо нажать плюсик.

.. figure:: ../../_static/images/tech/3_test_network/IP_Address_L2XC.png
    :align: center
    :alt: IP_Address_L2XC.png

    Формат адреса на интерфейсе.

И теперь мы можем пинговать в обе стороны в этой подсети.

.. code::

    > ping address=192.168.78.1
      SEQ HOST                                     SIZE TTL TIME  STATUS
        0 192.168.78.1                               56 255 73ms 
        1 192.168.78.1                               56 255 72ms 
        2 192.168.78.1                               56 255 61ms 
        sent=3 received=3 packet-loss=0% min-rtt=61ms avg-rtt=68ms max-rtt=73ms

    > ping address=192.168.78.2
      SEQ HOST                                     SIZE TTL TIME  STATUS
        0 192.168.78.2                               56  64 0ms  
        1 192.168.78.2                               56  64 0ms  
        2 192.168.78.2                               56  64 0ms  
        sent=3 received=3 packet-loss=0% min-rtt=0ms avg-rtt=0ms max-rtt=0ms

Клиент выделил /30 подсеть.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Проблема в том, что адресов, которые можно назначить устройствам, в этой подсети всего 2 и оба используются клиентом.

В этой ситуации нам придется разорвать L2-связность между стыком и клиентским оборудованием и для оборудования на объекте стать на время РУСом, а для РУСа - клиентским оборудованием на объекте.

Рассмотрим это пошагово:

#. Выключить интерфейс vpls1, прописать адрес клиентского РУСа на L2XC. Таким образом мы выступи в роли РУСа для клиентского оборудования и сможем проверить физику на наличие потерь пакетов.
#. Убрать адрес РУСа с антенны, выключить интерфейс ether1, включить vpls1, прописать адрес клиентского оборудования на интерфейсе L2XC. Так мы "станем" клиентским оборудованием для РУСа и сможем провести тестирование радиоканала.
#. После проведения всех тестов необходимо удалить тестовую адресацию с антенны и включить обратно vpls1.

Пример с /30 подсетью.
""""""""""""""""""""""""""

Для примера, клиент выделил подсеть 192.168.78.0/30, на объекте используется 192.168.78.2, на РУС - 192.168.78.1. Свободных адресов для использования нами нет, придется использовать уже занятые клиентом. Но для того, чтобы на сети не возникло конфликта адресов, нужно поочередно отключать интерфейсы, на которых эти адреса уже используются. Отключаем vpls1, прописываем адрес РУСа на L2XC (192.168.78.1/29) и пингуем клиентское оборудование. 

.. figure:: ../../_static/images/tech/3_test_network/IP_Address_30_ether1.png
    :align: center
    :alt: IP_Address_30_ether1.png

    Выключить vpls1, прописать адрес на L2XC, пропинговать клиентское оборудование.

После этого отключаем ether1, прописываем адрес клиентского оборудования на L2XC (192.168.78.2/29), включаем vpls1 и тестируем радиоканал пингуя стык. 

.. figure:: ../../_static/images/tech/3_test_network/IP_Address_30_vpls1.png
    :align: center
    :alt: IP_Address_30_vpls1.png

    Выключить ether1, прописать адрес на L2XC, пропинговать РУС под нагрузкой.

После завершения тестирования удаляем адресацию с L2XC и включаем ether1. 
